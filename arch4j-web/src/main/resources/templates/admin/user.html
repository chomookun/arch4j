<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="admin/_admin.html">
<main layout:fragment="_main">
    <script>
        const userSearch = new duice.ObjectProxy({
            key: 'username',
            value: null,
            type: null,
            status: null,
            _page: 0,
            _size: 20,
            _count: 0
        });

        const users = new duice.ArrayProxy([]);

        /**
         * getUsers
         */
        function getUsers() {
            let url = new URL("[[@{/admin/user/get-users}]]", document.location.origin);
            if (userSearch.key && userSearch.value) {
                url.searchParams.append(userSearch.key, userSearch.value);
            }
            if(userSearch.type) {
                url.searchParams.append('type', userSearch.type);
            }
            if(userSearch.status) {
                url.searchParams.append('status', userSearch.status);
            }
            url.searchParams.append('_page', userSearch._page);
            url.searchParams.append('_size', userSearch._size);
            duice.fetch(url)
                .then(async response => {
                    let json = await response.json();
                    duice.ArrayProxy.assign(users, json.content);
                    console.log(json.totalElements);
                    userSearch._count = json.totalElements;
                });
        }

        /**
         * resetUserSearch
         */
        function resetUserSearch() {
            getUsers();
        }

        document.addEventListener('DOMContentLoaded',()=> {
            let tabFolder = duice.tabFolder(
                duice.tabItem(document.getElementById('userTabButton'), document.getElementById('userTabContent'), () => {
                    getUsers();
                }),
                duice.tabItem(document.getElementById('roleTabButton'), document.getElementById('roleTabContent'), () => {
                    //getUsers();
                }),
                duice.tabItem(document.getElementById('authorityTabButton'), document.getElementById('authorityTabContent'), () => {
                    //getUsers();
                })
            );
            tabFolder.setActive(0);
        });
    </script>
    <h1>
        <img th:src="@{/static/image/icon-user.png}"/>
        <span data-th-text="#{web.title.user}"></span>
    </h1>
    <div class="tab">
        <button id="userTabButton" class="tab__button">
            <img class="icon" th:src="@{/static/image/icon-user.png}"/>
            <span data-th-text="#{core.user}"></span>
        </button>
        <button id="roleTabButton" class="tab__button">
            <img class="icon" th:src="@{/static/image/icon-role.png}"/>
            <span data-th-text="#{core.role}"></span>
        </button>
        <button id="authorityTabButton" class="tab__button">
            <img class="icon" th:src="@{/static/image/icon-authority.png}"/>
            <span data-th-text="#{core.authority}"></span>
        </button>
    </div>
    <!-- userTabContent -->
    <div id="userTabContent">
        <div class="row">
            <div class="col">
                <form onsubmit="return false;">
                    <select data-duice-object="userSearch" data-duice-property="key">
                        <option value="username" th:text="#{core.user.username}"></option>
                        <option value="nickname" th:text="#{core.user.nickname}"></option>
                        <option value="email" th:text="#{core.user.email}"></option>
                        <option value="mobile" th:text="#{core.user.mobile}"></option>
                    </select>
                    <input type="text" data-duice-object="userSearch" data-duice-property="value" th:placeholder="#{web.text.keyword}"/>
                    <select data-duice-object="userSearch" data-duice-property="type">
                        <option value data-th-text="'- '+#{core.user.type}+' -'"></option>
                        <option th:each="userType:${userTypes}" th:value="${userType}" th:text="${userType}"></option>
                    </select>
                    <select data-duice-object="userSearch" data-duice-property="status">
                        <option value data-th-text="'- '+#{core.user.status}+' -'"></option>
                        <option th:each="userStatus:${userStatuses}" th:value="${userStatus}" th:text="${userStatus}"></option>
                    </select>
                    <button onclick="getUsers();">
                        <img class="icon" th:src="@{/static/image/icon-search.png}"/>
                        <span data-th-text="#{web.text.search}">Search</span>
                    </button>
                    <button onclick="resetUserSearch();">
                        <img class="icon" th:src="@{/static/image/icon-reset.png}"/>
                        <span data-th-text="#{web.text.reset}">Reset</span>
                    </button>
                </form>
            </div>
            <div class="col">
                <button onclick="">
                    <img class="icon" th:src="@{/static/image/icon-create.png}"/>
                    <span data-th-text="#{web.text.create}"></span>
                </button>
            </div>
        </div>
        <table>
            <colgroup>
                <col style="width:100px;"/>
                <col/>
                <col/>
                <col/>
                <col/>
                <col/>
                <col/>
                <col/>
                <col style="width:70px;"/>
            </colgroup>
            <thead>
            <tr>
                <th data-th-text="#{web.text.no}" class="ta-center"></th>
                <th data-th-text="#{core.user.username}"></th>
                <th data-th-text="#{core.user.nickname}"></th>
                <th data-th-text="#{core.user.email}"></th>
                <th data-th-text="#{core.user.mobile}"></th>
                <th data-th-text="#{core.user.type}"></th>
                <th data-th-text="#{core.user.status}"></th>
                <th data-th-text="#{core.user.roles}"></th>
                <th class="ta-center">-</th>
            </tr>
            </thead>
            <tbody>
            <tr data-duice-array="users" data-duice-loop="user,status">
                <td data-duice-object="status" data-duice-property="count" class="ta-center"></td>
                <td data-duice-object="user" data-duice-property="username"></td>
                <td data-duice-object="user" data-duice-property="nickname"></td>
                <td data-duice-object="user" data-duice-property="email"></td>
                <td data-duice-object="user" data-duice-property="mobile"></td>
                <td><span data-duice-object="user" data-duice-property="type"></span></td>
                <td><span data-duice-object="user" data-duice-property="status"></span></td>
                <td>
                    <span data-duice-object="user" data-duice-script="
                    let roleIds = [];
                    user.roles.forEach(role => {
                        roleIds.push(role.id);
                    });
                    this.appendChild(document.createTextNode(roleIds.join(',')));
                    "></span>
                </td>
                <td class="ta-center">
                    <button>
                        <img class="icon" th:src="@{/static/image/icon-detail.png}"/>
                        <span data-th-text="#{web.text.detail}">Detail</span>
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <div class="row">
            <div class="col"></div>
            <div class="col">
                <duice-pagination
                        data-duice-object="userSearch"
                        data-duice-size-property="_size"
                        data-duice-page-property="_page"
                        data-duice-count-property="_count"
                        data-duice-onclick="getUsers(this.dataset.page);">
                </duice-pagination>
            </div>
            <div class="col">
                <span data-th-text="#{web.text.total}"></span>
                <span data-duice-object="userSearch" data-duice-property="_count" data-duice-format="number(0)"></span>
                <span data-th-text="#{web.text.rows}"></span>
            </div>
        </div>
    </div>
    <!-- roleTabContent -->
    <div id="roleTabContent">
        roleTabContent
    </div>
    <!-- authorityTabContent -->
    <div id="authorityTabContent">
        authorityTabContent
    </div>

</main>