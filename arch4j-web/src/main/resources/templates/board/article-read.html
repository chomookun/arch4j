<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="_web.html">
<main layout:fragment="_main">
    <script>
        const boardId = '[[${board.id}]]';
        const articleId = '[[${param.id}]]';
        const article = new duice.ObjectProxy({
            files:[]
        });
        const comments = new duice.ArrayProxy([]);
        const comment = new duice.ObjectProxy({});

        /**
         * get article
         */
        function getArticle() {
            let url = new URL(`${_apiUrl}/v1/board/${boardId}/article/${articleId}`, document.location.origin);
            _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ObjectProxy.clear(article);
                    duice.ObjectProxy.assign(article, data);
                });
        }

        /**
         * get comments
         */
        function getComments() {
            let url = new URL(`${_apiUrl}/v1/board/${boardId}/article/${articleId}/comment`, document.location.origin);
            _fetch(url)
                .then(response => response.json())
                .then(data => {
                    duice.ArrayProxy.clear(comments);
                    duice.ArrayProxy.assign(comments, data);
                });
        }

        /**
         * add article comment
         * @param parentId
         */
        function addComment(parentId) {
            duice.ObjectProxy.clear(comment);
            comment.parentId = parentId;
            let commentPost = document.getElementById('comment-post');
            let parentCommentId = document.querySelector(`[data-comment-id="${parentId}"]`);
            parentCommentId.appendChild(commentPost);
        }

        /**
         * clear comment
         */
        function clearComment() {
            duice.ObjectProxy.clear(comment);
            let commentPost = document.getElementById('comment-post');
            let commentPostContainer = document.getElementById('comment-post-container');
            commentPostContainer.appendChild(commentPost);
        }

        /**
         * save article comment
         */
        function saveComment(){
            let url = new URL(`${_apiUrl}/v1/board/${boardId}/article/${articleId}/comment`, document.location.origin);
            _fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(comment)
            }).then(response => {
                if(response.ok) {
                    clearComment();
                    getComments();
                }
            })
        }

        /**
         * download file
         * @param fileId
         */
        function downloadFile(fileId) {
            let link = document.createElement('a');
            link.href = `${_apiUrl}/v1/file/${fileId}`;
            link.click();
        }

        /**
         * goto article edit
         */
        function gotoEdit() {
            document.location.href = `[[@{/}]]board/${boardId}/article-post?id=${articleId}`;
        }

        /**
         * goto list
         */
        function gotoList() {
            document.location.href = `[[@{/}]]board/${boardId}`;
        }

        // onload
        document.addEventListener('DOMContentLoaded', event => {
            getArticle();
            getComments();
        });
    </script>
    <th:block th:replace="|theme/${_theme}/board/${board.skin}/article-read.html|"/>
</main>
